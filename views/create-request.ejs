<%- include('partials/header') %>

<div class="main-card">
    <h2>إنشاء طلب دواء جديد</h2>
    <p>يرجى تعبئة البيانات التالية بدقة لضمان وصول الدواء إليكم.</p>
    
    <form id="requestForm">
        <label for="fullName">الاسم الكامل</label>
        <input type="text" id="fullName" placeholder="مثال: محمد أحمد" required>

        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label for="medicalFile">رقم الملف الطبي</label>
                <input type="text" id="medicalFile" placeholder="12345" required>
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label for="nationalId">رقم الهوية</label>
                <input type="text" id="nationalId" maxlength="10" placeholder="10 أرقام" required>
            </div>
        </div>

        <label for="phone">رقم الجوال</label>
        <input type="text" id="phone" placeholder="05xxxxxxxx" required>

        <div style="margin: 30px 0; padding: 20px; border: 1px dashed #cbd5e1; border-radius: 20px; background: rgba(248, 250, 252, 0.5);">
            <h3 style="color: var(--blue-900); font-size: 18px; margin-top: 0; margin-bottom: 15px;">تفاصيل العنوان الوطني</h3>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                <div style="flex: 1; min-width: 120px;"><label style="font-size: 13px;">العنوان المختصر</label><input type="text" id="shortAddress" placeholder="JDAA0000" required></div>
                <div style="flex: 1; min-width: 120px;"><label style="font-size: 13px;">المدينة</label><input type="text" id="city" placeholder="جدة" required></div>
                <div style="flex: 1; min-width: 120px;"><label style="font-size: 13px;">الحي</label><input type="text" id="district" placeholder="الروضة" required></div>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 120px;"><label style="font-size: 13px;">الشارع</label><input type="text" id="street" placeholder="الملك فهد" required></div>
                <div style="flex: 1; min-width: 120px;"><label style="font-size: 13px;">رقم المبنى</label><input type="text" id="buildingNum" placeholder="1234" required></div>
                <div style="flex: 1; min-width: 120px;"><label style="font-size: 13px;">الرقم الفرعي</label><input type="text" id="extraNum" placeholder="5678"></div>
                <div style="flex: 1; min-width: 120px;"><label style="font-size: 13px;">الرمز البريدي</label><input type="text" id="postalCode" placeholder="12345"></div>
            </div>
        </div>

        <div id="statusMsg" style="margin-top: 20px; padding: 15px; border-radius: 15px; display: none; text-align: center; font-weight: bold;"></div>
        <div id="errorAlert" style="display: none; background: #fff1f2; color: #e11d48; padding: 12px; border-radius: 12px; border: 1px solid #fda4af; margin-bottom: 15px; text-align: center; font-weight: bold; font-size: 14px;">
</div>

        <button type="submit" class="btn btn-primary" style="margin-top: 10px;">إرسال الطلب الآن</button>
    </form>
</div>

<script>
    const STORAGE_KEY = "maeenak_requests_v1";
    const form = document.getElementById("requestForm");
    const errorAlert = document.getElementById("errorAlert");
    const statusMsg = document.getElementById("statusMsg");

    form.addEventListener("submit", function(e) {
        e.preventDefault();
        
        // إخفاء الرسائل السابقة
        errorAlert.style.display = "none";
        statusMsg.style.display = "none";

        const nid = document.getElementById("nationalId").value.trim();
        const ph = document.getElementById("phone").value.trim();

        // التحقق من رقم الهوية
        if (!/^\d{10}$/.test(nid)) {
            errorAlert.textContent = "⚠️ رقم الهوية يجب أن يتكون من 10 أرقام";
            errorAlert.style.display = "block";
            errorAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        // التحقق من رقم الجوال
        if (!/^05\d{8}$/.test(ph)) {
            errorAlert.textContent = "⚠️ رقم الجوال يجب أن يبدأ بـ 05 ويتكون من 10 أرقام";
            errorAlert.style.display = "block";
            errorAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        // إذا كانت البيانات صحيحة، نكمل عملية الحفظ
        const newRequest = {
            id: "REQ-" + Math.random().toString(36).substring(2, 8).toUpperCase(),
            fullName: document.getElementById("fullName").value.trim(),
            medicalFile: document.getElementById("medicalFile").value.trim(),
            nationalId: nid,
            phone: ph,
            addressDetails: {
                short: document.getElementById("shortAddress").value,
                city: document.getElementById("city").value,
                district: document.getElementById("district").value,
                street: document.getElementById("street").value,
                building: document.getElementById("buildingNum").value,
                extra: document.getElementById("extraNum").value,
                postal: document.getElementById("postalCode").value
            },
            status: "قيد المراجعة",
            createdAt: new Date().toISOString()
        };

        const requests = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        requests.push(newRequest);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(requests));

        statusMsg.textContent = "تم استلام طلبك بنجاح! رقم الطلب: " + newRequest.id;
        statusMsg.style.display = "block";
        statusMsg.style.background = "#dcfce7";
        statusMsg.style.color = "#166534";
        
        this.reset();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
</script>

<%- include('partials/footer') %>
