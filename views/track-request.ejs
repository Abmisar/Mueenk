<%- include('partials/header') %>

<div class="main-card">
    <h2 style="color: var(--blue-900); text-align: center; font-weight: 900;">تتبع طلبك</h2>
    <p style="text-align: center; color: #64748b; margin-bottom: 30px;">أدخل رقم الهوية لمشاهدة حالة طلبك الحالية.</p>
    
    <form id="trackForm">
        <input type="text" id="trackInput" placeholder="رقم الهوية أو الملف الطبي" required>
        <button type="submit" class="btn-primary" style="border: none; width: 100%; cursor: pointer;">بحث</button>
    </form>

    <div id="errorMsg" style="margin-top: 20px; color: #ef4444; text-align: center; display: none; font-weight: bold;"></div>

    <div id="trackResult" style="display: none; margin-top: 35px; text-align: right; animation: fadeIn 0.5s ease;">
        <div id="resStatusBadge" style="background: var(--blue-900); color: white; padding: 8px 20px; border-radius: 50px; display: inline-block; margin-bottom: 20px; font-weight: bold;"></div>
        
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 25px; padding: 25px;">
            <div style="border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 15px;">
                <p style="margin: 5px 0;"><b>رقم الطلب:</b> <span id="resId" style="color: var(--blue-600);"></span></p>
                <p style="margin: 5px 0;"><b>اسم المريض:</b> <span id="resName"></span></p>
                <p style="margin: 5px 0;"><b>رقم الهوية:</b> <span id="resNationalId"></span></p>
                <p style="margin: 5px 0;"><b>الملف الطبي:</b> <span id="resMedicalFile"></span></p>
                <p style="margin: 5px 0;"><b>الجوال:</b> <span id="resPhone"></span></p>
            </div>
            
            <div style="margin-top: 10px;">
                <p style="font-weight: 900; color: var(--blue-900); margin-bottom: 10px;">تفاصيل العنوان الوطني:</p>
                <div id="resAddressGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; color: #475569;">
                    </div>
            </div>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = "maeenak_requests_v1";
    document.getElementById("trackForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const input = document.getElementById("trackInput").value.trim();
        const requests = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        
        const matched = requests.filter(r => r.nationalId === input || r.medicalFile === input)
                               .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

        if (matched.length === 0) {
            document.getElementById("trackResult").style.display = "none";
            document.getElementById("errorMsg").textContent = "عذراً، لم يتم العثور على طلب بهذا الرقم.";
            document.getElementById("errorMsg").style.display = "block";
            return;
        }

        const latest = matched[0];
        const addr = latest.addressDetails || {};
        
        document.getElementById("errorMsg").style.display = "none";
        document.getElementById("trackResult").style.display = "block";
        document.getElementById("resStatusBadge").textContent = "الحالة: " + latest.status;
        document.getElementById("resId").textContent = latest.id;
        document.getElementById("resName").textContent = latest.fullName;
        document.getElementById("resPhone").textContent = latest.phone;
        
        // عرض الهوية والملف الطبي
        document.getElementById("resNationalId").textContent = latest.nationalId || '-';
        document.getElementById("resMedicalFile").textContent = latest.medicalFile || '-';

        // عرض تفاصيل العنوان شاملة الرقم الفرعي
        document.getElementById("resAddressGrid").innerHTML = `
            <span><b>المختصر:</b> ${addr.short || '-'}</span>
            <span><b>المدينة:</b> ${addr.city || '-'}</span>
            <span><b>الحي:</b> ${addr.district || '-'}</span>
            <span><b>الشارع:</b> ${addr.street || '-'}</span>
            <span><b>المبنى:</b> ${addr.building || '-'}</span>
            <span><b>الرقم الفرعي:</b> ${addr.extra || '-'}</span>
            <span><b>الرمز البريدي:</b> ${addr.postal || '-'}</span>
        `;
    });
</script>

<%- include('partials/footer') %>
