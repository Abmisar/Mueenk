<%- include('partials/header') %>

<%
  const statusMap = {
    PENDING: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
    DELIVERED_SPL: "ØªÙˆØµÙŠÙ„ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø³Ø¨Ù„",
    RECEIVED_WASFTI: "Ø§Ø³ØªÙ„Ø§Ù… Ø¹Ù† Ø·Ø±ÙŠÙ‚ ÙˆØµÙØªÙŠ",
    CANCELLED: "Ù…Ù„ØºÙ‰",
    PRESCRIPTION_EXPIRED: "Ø§Ù„ÙˆØµÙØ© Ù…Ù†ØªÙ‡ÙŠØ©"
  };
  const statusLabel = statusMap[request.status] || request.status;
%>

<div class="main-card" style="max-width: 900px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px;">
        <h2 style="margin: 0; color: var(--blue-900);">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨: <%= request.req_id %></h2>
        <span id="currentStatusDisplay" style="background: var(--blue-900); color: white; padding: 8px 20px; border-radius: 50px; font-weight: bold; font-size: 14px;">
            <%= statusLabel %>
        </span>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
        <div style="background: #f8fafc; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0;">
            <p style="margin: 0 0 5px; color: #64748b; font-size: 12px;">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</p>
            <p style="margin: 0; font-weight: 800;"><%= request.full_name %></p>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0;">
            <p style="margin: 0 0 5px; color: #64748b; font-size: 12px;">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø·Ø¨ÙŠ</p>
            <p style="margin: 0; font-weight: 800;"><%= request.medical_file %></p>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0;">
            <p style="margin: 0 0 5px; color: #64748b; font-size: 12px;">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</p>
            <p style="margin: 0; font-weight: 800;"><%= request.national_id %></p>
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 15px; border: 1px solid #e2e8f0;">
            <p style="margin: 0 0 5px; color: #64748b; font-size: 12px;">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</p>
            <p style="margin: 0; font-weight: 800;"><%= request.phone %></p>
        </div>
    </div>

    <h3 style="color: var(--blue-900); font-size: 16px; margin-bottom: 15px;">ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ·Ù†ÙŠ</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 25px;">
        <div style="background: #f1f5f9; padding: 12px; border-radius: 12px; text-align: center;">
            <p style="margin: 0 0 4px; color: #64748b; font-size: 11px;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø®ØªØµØ±</p>
            <p style="margin: 0; font-weight: 700; color: var(--blue-900);"><%= request.short_address %></p>
        </div>
        <div style="background: #f1f5f9; padding: 12px; border-radius: 12px; text-align: center;">
            <p style="margin: 0 0 4px; color: #64748b; font-size: 11px;">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</p>
            <p style="margin: 0; font-weight: 700; color: var(--blue-900);"><%= request.city %></p>
        </div>
        <div style="background: #f1f5f9; padding: 12px; border-radius: 12px; text-align: center;">
            <p style="margin: 0 0 4px; color: #64748b; font-size: 11px;">Ø§Ù„Ø­ÙŠ</p>
            <p style="margin: 0; font-weight: 700; color: var(--blue-900);"><%= request.district %></p>
        </div>
        <div style="background: #f1f5f9; padding: 12px; border-radius: 12px; text-align: center;">
            <p style="margin: 0 0 4px; color: #64748b; font-size: 11px;">Ø§Ù„Ø´Ø§Ø±Ø¹</p>
            <p style="margin: 0; font-weight: 700; color: var(--blue-900);"><%= request.street %></p>
        </div>
        <div style="background: #f1f5f9; padding: 12px; border-radius: 12px; text-align: center;">
            <p style="margin: 0 0 4px; color: #64748b; font-size: 11px;">Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰</p>
            <p style="margin: 0; font-weight: 700; color: var(--blue-900);"><%= request.building_num %></p>
        </div>
        <div style="background: #f1f5f9; padding: 12px; border-radius: 12px; text-align: center;">
            <p style="margin: 0 0 4px; color: #64748b; font-size: 11px;">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ</p>
            <p style="margin: 0; font-weight: 700; color: var(--blue-900);"><%= request.postal_code %></p>
        </div>
    </div>

    <% if (request.patient_notes) { %>
        <div style="margin-bottom: 35px; padding: 20px; background: #fff7ed; border: 1px solid #ffedd5; border-radius: 20px; border-right: 6px solid #ea580c;">
            <h4 style="margin: 0 0 10px 0; color: #9a3412; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù† Ø§Ù„Ù…Ø±ÙŠØ¶:
            </h4>
            <p style="margin: 0; color: #7c2d12; font-size: 15px; line-height: 1.6; font-weight: 500;">
                <%= request.patient_notes %>
            </p>
        </div>
    <% } else { %>
        <div style="margin-bottom: 35px; padding: 15px; background: #f8fafc; border: 1px dashed #e2e8f0; border-radius: 15px; color: #94a3b8; text-align: center; font-size: 14px;">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø±ÙŠØ¶.
        </div>
    <% } %>

    <h3 style="color: var(--blue-900); font-size: 18px; margin-bottom: 20px;"> Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ±Ù:</h3>

    <div class="btn-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px;">
        <button type="button" onclick="selectStatus(this, 'DELIVERED_SPL')" class="btn-action-select"
          style="border: 2px solid #3b82f6; background: transparent; color: #3b82f6; padding: 15px; border-radius: 15px; cursor: pointer; font-weight: bold;">
          ğŸ“¦ ØªÙˆØµÙŠÙ„ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø³Ø¨Ù„
        </button>

        <button type="button" onclick="selectStatus(this, 'RECEIVED_WASFTI')" class="btn-action-select"
          style="border: 2px solid #f59e0b; background: transparent; color: #f59e0b; padding: 15px; border-radius: 15px; cursor: pointer; font-weight: bold;">
          ğŸ”— Ø§Ø³ØªÙ„Ø§Ù… Ø¹Ù† Ø·Ø±ÙŠÙ‚ ÙˆØµÙØªÙŠ
        </button>

        <button type="button" onclick="selectStatus(this, 'CANCELLED')" class="btn-action-select"
          style="border: 2px solid #ef4444; background: transparent; color: #ef4444; padding: 15px; border-radius: 15px; cursor: pointer; font-weight: bold;">
          âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
        </button>

        <button type="button" onclick="selectStatus(this, 'PRESCRIPTION_EXPIRED')" class="btn-action-select"
          style="border: 2px solid #64748b; background: transparent; color: #64748b; padding: 15px; border-radius: 15px; cursor: pointer; font-weight: bold;">
          ğŸš« Ø§Ù„ÙˆØµÙØ© Ù…Ù†ØªÙ‡ÙŠØ©
        </button>
    </div>

    <h3 style="color: var(--blue-900); font-size: 18px; margin-bottom: 20px;"> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„ÙŠ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: </h3>

    <div style="background: #f8fafc; padding: 25px; border-radius: 25px; border: 1px solid #e2e8f0; margin-bottom: 25px;">

        <div id="validationWarning" style="display: none; background: #fff1f2; color: #e11d48; padding: 15px; border-radius: 12px; border: 1px solid #fda4af; margin-bottom: 20px; text-align: center; font-weight: bold; animation: shake 0.5s;">
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; font-size: 14px; margin-bottom: 8px; color: var(--blue-900); font-weight: bold;">Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: <span style="color: #ef4444;">*</span></label>
            <input type="text" id="ph_name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 14px; margin-bottom: 8px; color: var(--blue-900); font-weight: bold;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹ / Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡):</label>
            <textarea id="ph_notes" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªÙŠ Ø³ÙŠØ±Ø§Ù‡Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶..." style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; font-family: inherit;"></textarea>
        </div>

        <button type="button" onclick="validateAndSubmit()" class="btn-primary" style="width: 100%; background: var(--blue-900); padding: 18px; font-size: 16px; border-radius: 15px;">
            Ø¥Ø±Ø³Ø§Ù„ ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ğŸš€
        </button>
    </div>

    <form id="realStatusForm" action="/update-status/<%= request.req_id %>" method="POST" style="display: none;">
        <input type="hidden" name="newStatus" id="input_status">
        <input type="hidden" name="pharmacistName" id="input_phName">
        <input type="hidden" name="clientNotes" id="input_notes">
    </form>

    <div style="margin-top: 30px; text-align: center;">
        <a href="/requests-list" style="color: var(--blue-600); font-weight: 700; text-decoration: none;">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
    </div>
</div>

<style>
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-8px); }
        75% { transform: translateX(8px); }
    }
</style>

<script>
let selectedStatusValue = "";

function selectStatus(btn, status) {
    document.querySelectorAll('.btn-action-select').forEach(el => {
        el.style.background = "transparent";
        el.style.color = el.style.borderColor;
    });

    btn.style.background = btn.style.borderColor;
    btn.style.color = "white";
    selectedStatusValue = status;

    document.getElementById('validationWarning').style.display = "none";
}

function validateAndSubmit() {
    const name = document.getElementById('ph_name').value.trim();
    const notes = document.getElementById('ph_notes').value.trim();
    const warningBox = document.getElementById('validationWarning');

    document.getElementById('ph_name').style.borderColor = "#cbd5e1";
    warningBox.style.display = "none";

    if (!selectedStatusValue) {
        warningBox.textContent = "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ±Ù' Ø£ÙˆÙ„Ø§Ù‹.";
        warningBox.style.display = "block";
        return;
    }

    if (!name) {
        warningBox.textContent = "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ 'Ø§Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„' Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.";
        warningBox.style.display = "block";
        document.getElementById('ph_name').style.borderColor = "#ef4444";
        return;
    }

    document.getElementById('input_status').value = selectedStatusValue;
    document.getElementById('input_phName').value = name;
    document.getElementById('input_notes').value = notes;

    document.getElementById('realStatusForm').submit();
}
</script>

<%- include('partials/footer') %>
